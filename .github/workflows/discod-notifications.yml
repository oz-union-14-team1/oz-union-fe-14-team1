name: Discord Notifications

on:
  pull_request:
    types: [opened, review_requested, closed]
  pull_request_review:
    types: [submitted]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      # PR ìƒì„± ì•Œë¦¼
      - name: Notify on PR Opened
        if: github.event.action == 'opened'
        run: |
          curl -H "Content-Type: application/json" \
            -X POST \
            -d '{
              "embeds": [{
                "title": "ğŸ†• ìƒˆë¡œìš´ PRì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!",
                "description": "[${{ github.event.pull_request.title }}](${{ github.event.pull_request.html_url }})",
                "color": 3447003,
                "fields": [
                  { "name": "ğŸ‘¤ ì‘ì„±ì", "value": "${{ github.event.pull_request.user.login }}", "inline": true },
                  { "name": "ğŸŒ¿ ë¸Œëœì¹˜", "value": "`${{ github.event.pull_request.head.ref }}` â†’ `${{ github.event.pull_request.base.ref }}`", "inline": true },
                  { "name": "ğŸ“Š ë³€ê²½ì‚¬í•­", "value": "+${{ github.event.pull_request.additions }} -${{ github.event.pull_request.deletions }}", "inline": true }
                ],
                "timestamp": "${{ github.event.pull_request.created_at }}"
              }]
            }' \
            ${{ secrets.DISCORD_WEBHOOK_URL }}

      # ë¦¬ë·°ì–´ ë©˜ì…˜ (ì¤‘ë³µ ë°©ì§€)
      - name: Mention Reviewers
        if: github.event.action == 'review_requested'
        run: |
          REVIEWERS_JSON='${{ toJSON(github.event.pull_request.requested_reviewers) }}'
          FIRST_REVIEWER=$(echo "$REVIEWERS_JSON" | jq -r '.[0].login // empty')
          CURRENT_REVIEWER="${{ github.event.requested_reviewer.login }}"

          if [ "$CURRENT_REVIEWER" = "$FIRST_REVIEWER" ] || [ -z "$FIRST_REVIEWER" ]; then
            MENTIONS=""
            for login in $(echo "$REVIEWERS_JSON" | jq -r '.[] | .login'); do
              case "$login" in
                "chen4023")      MENTIONS="$MENTIONS <@683563560063991848>" ;;
                "G-jjunny")      MENTIONS="$MENTIONS <@382857559532371968>" ;;
                "SammyLee519")   MENTIONS="$MENTIONS <@1366576628494372905>" ;;
                "sowonhub")      MENTIONS="$MENTIONS <@1402544152125898802>" ;;
                "WoongBaeJeon")  MENTIONS="$MENTIONS <@1325430352843636736>" ;;
                "lollonoaJoro")  MENTIONS="$MENTIONS <@738738910724882462>" ;;
                *)               MENTIONS="$MENTIONS @$login" ;;
              esac
            done

            curl -H "Content-Type: application/json" \
              -X POST \
              -d "{
                \"content\": \"ğŸ” **ë¦¬ë·° ìš”ì²­ì´ ë„ì°©í–ˆìŠµë‹ˆë‹¤!** $MENTIONS\",
                \"embeds\": [{
                  \"title\": \"ë¦¬ë·°ë¥¼ ë¶€íƒë“œë¦½ë‹ˆë‹¤! ğŸ‘€\",
                  \"description\": \"[${{ github.event.pull_request.title }}](${{ github.event.pull_request.html_url }})\",
                  \"color\": 16776960
                }]
              }" \
              ${{ secrets.DISCORD_WEBHOOK_URL }}
          fi

      # PR ì¢…ë£Œ / ë³‘í•©
      - name: Notify on PR Closed
        if: github.event.action == 'closed'
        run: |
          if [ "${{ github.event.pull_request.merged }}" = "true" ]; then
            STATUS="âœ… ë³‘í•© ì™„ë£Œ!"
            COLOR=65280
          else
            STATUS="âŒ PR ë‹«í˜"
            COLOR=16711680
          fi

          curl -H "Content-Type: application/json" \
            -X POST \
            -d "{
              \"embeds\": [{
                \"title\": \"$STATUS\",
                \"description\": \"[${{ github.event.pull_request.title }}](${{ github.event.pull_request.html_url }})\",
                \"color\": $COLOR
              }]
            }" \
            ${{ secrets.DISCORD_WEBHOOK_URL }}
